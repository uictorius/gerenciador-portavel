<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'none'; connect-src 'none'; font-src 'self'; object-src 'none'; media-src 'none'; frame-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'none';">
<title>SecureVault</title>
<style id="mainStyle">
/* Reset & Base */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg: #0a0e1a;
    --bg-sec: #141925;
    --bg-card: #1e2436;
    --border: #2a3245;
    --txt: #e4e7ed;
    --txt-sec: #8892a6;
    --accent: #4c6ef5;
    --accent-hover: #5c7cfa;
    --danger: #f03e3e;
    --success: #37b24d;
    --warn: #fcc419;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, var(--bg) 0%, #0f1523 100%);
    color: var(--txt);
    min-height: 100vh;
    line-height: 1.6;
    overflow-x: hidden;
}

/* Auth Container */
.auth-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

.auth-box {
    background: var(--bg-card);
    padding: 40px;
    border-radius: 16px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 1px solid var(--border);
}

.auth-box h1 {
    margin-bottom: 8px;
    font-size: 28px;
    background: linear-gradient(135deg, var(--accent) 0%, #748ffc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.auth-box p {
    color: var(--txt-sec);
    margin-bottom: 24px;
    font-size: 14px;
}

/* Dashboard */
.dashboard {
    display: none;
    min-height: 100vh;
}

.header {
    background: var(--bg-sec);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    font-size: 20px;
    font-weight: bold;
    background: linear-gradient(135deg, var(--accent) 0%, #748ffc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.container {
    display: flex;
    height: calc(100vh - 65px);
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: var(--bg-sec);
    border-right: 1px solid var(--border);
    padding: 24px;
    overflow-y: auto;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 4px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--txt-sec);
}

.menu-item:hover {
    background: var(--bg-card);
    color: var(--txt);
}

.menu-item.active {
    background: var(--accent);
    color: white;
}

.menu-icon {
    width: 20px;
    margin-right: 12px;
    text-align: center;
}

.blk-list {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
}

.blk-item {
    padding: 8px 12px;
    margin-bottom: 4px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
}

.blk-item:hover {
    background: var(--bg-card);
}

.blk-item.active {
    background: var(--bg-card);
    border-left: 3px solid var(--accent);
}

/* Content Area */
.content {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
}

.section {
    display: none;
}

.section.active {
    display: block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.section-title {
    font-size: 24px;
    font-weight: 600;
}

/* Password Cards */
.pwd-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.pwd-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.pwd-header {
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.pwd-site {
    font-size: 16px;
    font-weight: 500;
}

.pwd-user {
    font-size: 14px;
    color: var(--txt-sec);
    margin-top: 4px;
}

.pwd-details {
    display: none;
    padding: 0 20px 20px;
    border-top: 1px solid var(--border);
}

.pwd-details.show {
    display: block;
}

.pwd-field {
    margin-top: 16px;
}

.pwd-field label {
    display: block;
    font-size: 12px;
    color: var(--txt-sec);
    margin-bottom: 8px;
}

.pwd-value-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
}

.pwd-value {
    flex: 1;
    padding: 10px 12px;
    background: var(--bg-sec);
    border-radius: 6px;
    font-family: monospace;
}

/* Generic Cards */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
}

/* Note Cards */
.note-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.note-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.note-title {
    font-weight: 500;
    margin-bottom: 8px;
}

.note-preview {
    color: var(--txt-sec);
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Person Cards */
.person-card {
    background: var(--bg-sec);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
}

.person-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}

.person-field:last-child {
    border-bottom: none;
}

.field-label {
    color: var(--txt-sec);
    font-size: 14px;
}

.field-value {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Forms */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--txt-sec);
    font-weight: 500;
}

.input, .select, .textarea {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-sec);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--txt);
    font-size: 14px;
    transition: all 0.2s;
    font-family: inherit;
}

.textarea {
    resize: vertical;
    min-height: 100px;
    max-height: 300px;
}

.input:focus, .select:focus, .textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.1);
}

.pwd-gen-opts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin: 16px 0;
}

.checkbox-group {
    display: flex;
    align-items: center;
}

.checkbox-group input {
    margin-right: 8px;
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--accent-hover);
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--bg-sec);
    color: var(--txt);
    border: 1px solid var(--border);
}

.btn-secondary:hover:not(:disabled) {
    background: var(--bg-card);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-icon {
    padding: 8px;
    border-radius: 6px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--txt-sec);
}

.btn-icon:hover {
    background: var(--bg-sec);
    color: var(--txt);
}

.btn-expand {
    padding: 6px 12px;
    font-size: 12px;
    background: var(--bg-sec);
    border: 1px solid var(--border);
}

/* Config */
.config-section {
    margin-bottom: 24px;
}

.config-title {
    font-size: 16px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 12px;
}

.radio-group label {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.radio-group input {
    margin-right: 8px;
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 24px;
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 20px;
    font-weight: 600;
}

/* Toast Notifications */
.toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    padding: 16px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1001;
}

.toast.show {
    display: flex;
    animation: slideUp 0.3s ease;
}

.toast.success {
    border-color: var(--success);
}

.toast.error {
    border-color: var(--danger);
}

@keyframes slideUp {
    from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 16px;
        max-height: 200px;
    }
    
    .content {
        padding: 16px;
    }
}
</style>
</head>
<body>

<!-- Auth Screen -->
<div class="auth-container" id="authScreen">
    <div class="auth-box">
        <h1>SecureVault</h1>
        <p id="authMsg">Digite sua senha mestre para acessar</p>
        <form id="authForm">
            <div class="form-group">
                <label>Senha Mestre</label>
                <input type="password" class="input" id="masterPwd" required minlength="8" maxlength="128" autocomplete="off">
            </div>
            <div class="form-group" id="confirmGroup" style="display:none">
                <label>Confirmar Senha</label>
                <input type="password" class="input" id="confirmPwd" minlength="8" maxlength="128" autocomplete="off">
            </div>
            <button type="submit" class="btn btn-primary" id="authBtn" style="width:100%">
                <span id="authBtnTxt">Entrar</span>
            </button>
        </form>
    </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
    <header class="header">
        <div class="logo">SecureVault</div>
        <div class="header-actions">
            <button class="btn-icon" id="configBtn" title="Configura√ß√µes">‚öô</button>
            <button class="btn btn-danger" id="logoutBtn">Sair</button>
        </div>
    </header>
    
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="menu-item active" data-section="passwords">
                <span class="menu-icon">‚ñ∂</span> Senhas
            </div>
            <div class="menu-item" data-section="generator">
                <span class="menu-icon">‚ñ∂</span> Gerador
            </div>
            <div class="menu-item" data-section="persons">
                <span class="menu-icon">‚ñ∂</span> Pessoas
            </div>
            <div class="menu-item" data-section="notes">
                <span class="menu-icon">‚ñ∂</span> Salvar Coisas
            </div>
            
            <div class="blk-list">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <span style="font-size:14px;color:var(--txt-sec)">Blocos</span>
                    <button class="btn-icon" id="addBlkBtn">+</button>
                </div>
                <div id="blkList"></div>
            </div>
        </aside>
        
        <!-- Content Area -->
        <main class="content">
            <!-- Passwords Section -->
            <section class="section active" id="passwords">
                <div class="section-header">
                    <h2 class="section-title">Senhas</h2>
                    <button class="btn btn-primary" id="addPwdBtn">+ Nova Senha</button>
                </div>
                <div id="pwdList"></div>
            </section>
            
            <!-- Generator Section -->
            <section class="section" id="generator">
                <div class="section-header">
                    <h2 class="section-title">Gerador de Senhas</h2>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label>Senha Gerada</label>
                        <div style="display:flex;gap:12px">
                            <input type="text" class="input" id="genPwd" readonly>
                            <button class="btn btn-secondary" id="copyGenBtn">Copiar</button>
                        </div>
                    </div>
                    <div class="pwd-gen-opts">
                        <div class="form-group">
                            <label>Tamanho</label>
                            <input type="number" class="input" id="genLen" value="16" min="4" max="128">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="genUpper" checked>
                            <label for="genUpper">Mai√∫sculas</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="genLower" checked>
                            <label for="genLower">Min√∫sculas</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="genNum" checked>
                            <label for="genNum">N√∫meros</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="genSym" checked>
                            <label for="genSym">S√≠mbolos</label>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="genPwdBtn">Gerar Nova Senha</button>
                </div>
            </section>
            
            <!-- Persons Section -->
            <section class="section" id="persons">
                <div class="section-header">
                    <h2 class="section-title">Gerador de Pessoas</h2>
                    <div>
                        <button class="btn btn-primary" id="genPersonBtn">Gerar Pessoa</button>
                        <button class="btn btn-secondary" id="showSavedPersonsBtn">Ver Salvos</button>
                    </div>
                </div>
                <div id="personContent"></div>
            </section>
            
            <!-- Notes Section -->
            <section class="section" id="notes">
                <div class="section-header">
                    <h2 class="section-title">Salvar Coisas</h2>
                    <button class="btn btn-primary" id="addNoteBtn">+ Nova Anota√ß√£o</button>
                </div>
                <div id="notesList"></div>
            </section>
        </main>
    </div>
</div>

<!-- Modals -->
<!-- Auth Modal for Re-authentication -->
<div class="modal" id="authModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Autentica√ß√£o Necess√°ria</h3>
            <button class="btn-icon modal-close" data-modal="authModal">‚úï</button>
        </div>
        <p style="margin-bottom:16px;color:var(--txt-sec)">Digite sua senha mestre para acessar as senhas</p>
        <form id="reauthForm">
            <div class="form-group">
                <label>Senha Mestre</label>
                <input type="password" class="input" id="authPwd" required autocomplete="off">
            </div>
            <button type="submit" class="btn btn-primary">Confirmar</button>
        </form>
    </div>
</div>

<!-- Block Modal -->
<div class="modal" id="blkModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Novo Bloco</h3>
            <button class="btn-icon modal-close" data-modal="blkModal">‚úï</button>
        </div>
        <form id="blkForm">
            <div class="form-group">
                <label>Nome do Bloco</label>
                <input type="text" class="input" id="blkName" required maxlength="50">
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
    </div>
</div>

<!-- Password Modal -->
<div class="modal" id="pwdModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Nova Senha</h3>
            <button class="btn-icon modal-close" data-modal="pwdModal">‚úï</button>
        </div>
        <form id="pwdForm">
            <div class="form-group">
                <label>Bloco</label>
                <select class="select" id="pwdBlk" required></select>
            </div>
            <div class="form-group">
                <label>Site/App</label>
                <input type="text" class="input" id="pwdSite" required maxlength="100">
            </div>
            <div class="form-group">
                <label>Email/Usu√°rio</label>
                <input type="text" class="input" id="pwdUsr" required maxlength="200">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <div style="display:flex;gap:12px">
                    <input type="text" class="input" id="pwdVal" required maxlength="500">
                    <button type="button" class="btn btn-secondary" id="genQuickPwdBtn">Gerar</button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
    </div>
</div>

<!-- Note Modal -->
<div class="modal" id="noteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Nova Anota√ß√£o</h3>
            <button class="btn-icon modal-close" data-modal="noteModal">‚úï</button>
        </div>
        <form id="noteForm">
            <div class="form-group">
                <label>Bloco</label>
                <select class="select" id="noteBlk" required></select>
            </div>
            <div class="form-group">
                <label>T√≠tulo</label>
                <input type="text" class="input" id="noteTitle" required maxlength="100">
            </div>
            <div class="form-group">
                <label>Conte√∫do</label>
                <textarea class="textarea" id="noteContent" required maxlength="5000"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
    </div>
</div>

<!-- Config Modal -->
<div class="modal" id="configModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Configura√ß√µes</h3>
            <button class="btn-icon modal-close" data-modal="configModal">‚úï</button>
        </div>
        <div class="config-section">
            <div class="config-title">Servi√ßo de Email Tempor√°rio</div>
            <div class="radio-group">
                <label>
                    <input type="radio" name="emailSvc" value="tuamae" checked>
                    TuaMaeAquelaUrsa
                </label>
                <label>
                    <input type="radio" name="emailSvc" value="firemail">
                    Firemail
                </label>
            </div>
        </div>
        <button class="btn btn-primary" id="saveConfigBtn">Salvar Configura√ß√µes</button>
    </div>
</div>

<!-- Toast Container -->
<div class="toast" id="toast">
    <span id="toastMsg"></span>
</div>

<script>
'use strict';

/**
 * SecureVault - Gerenciador de Senhas com Criptografia Local
 * 
 * Decis√µes de Seguran√ßa:
 * - Nenhum armazenamento de senha em mem√≥ria
 * - PBKDF2 com 300.000 itera√ß√µes
 * - AES-GCM com IV √∫nico por opera√ß√£o
 * - AAD para integridade estrutural
 * - Valida√ß√£o e sanitiza√ß√£o completa
 * - Zero XSS atrav√©s de textContent
 * - Re-autentica√ß√£o via teste de descriptografia
 */

// ===== SECURITY MODULE =====
const Security = {
    /**
     * Valida input contra XSS e inje√ß√µes
     * Bloqueia: tags HTML, javascript:, data:, eventos, etc.
     */
    validate(str, maxLen = 1000) {
        if (typeof str !== 'string') return false;
        if (str.length > maxLen) return false;
        
        // Regex para detectar tentativas de XSS
        const dangerous = [
            /<[^>]*>/gi,           // Qualquer tag HTML
            /javascript:/gi,        // javascript: protocol
            /on\w+\s*=/gi,         // Event handlers
            /data:[^,]*script/gi,  // data: URLs com script
            /<script/gi,           // Script tags
            /<iframe/gi,           // iframes
            /<object/gi,           // objects
            /<embed/gi,            // embeds
            /<img/gi,              // images (podem ter onerror)
            /<svg/gi,              // SVG (pode conter scripts)
            /eval\s*\(/gi,         // eval()
            /expression\s*\(/gi,   // CSS expressions
            /import\s+/gi,         // ES6 imports
            /require\s*\(/gi       // CommonJS requires
        ];
        
        for (const regex of dangerous) {
            if (regex.test(str)) return false;
        }
        
        return true;
    },
    
    /**
     * Rate limiting para prevenir for√ßa bruta
     */
    attempts: new Map(),
    
    checkRate(key, max = 5, window = 60000) {
        const now = Date.now();
        const attempt = this.attempts.get(key);
        
        if (!attempt || now - attempt.first > window) {
            this.attempts.set(key, { count: 1, first: now });
            return true;
        }
        
        attempt.count++;
        return attempt.count <= max;
    },
    
    /**
     * Limpa dados sens√≠veis da mem√≥ria
     */
    zeroize(obj) {
        if (typeof obj === 'string') {
            // Strings s√£o imut√°veis em JS, melhor que podemos fazer
            obj = null;
        } else if (obj instanceof Uint8Array) {
            crypto.getRandomValues(obj); // Sobrescreve com random
            obj.fill(0); // Depois zera
        } else if (obj && typeof obj === 'object') {
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    this.zeroize(obj[key]);
                    delete obj[key];
                }
            }
        }
    }
};

// ===== CRYPTO MODULE =====
const Crypto = {
    // Configura√ß√µes de seguran√ßa
    PBKDF2_ITERATIONS: 300000,  // 300k itera√ß√µes
    SALT_LENGTH: 32,
    IV_LENGTH: 16,
    TAG_LENGTH: 128,
    
    /**
     * Deriva chave da senha usando PBKDF2
     * A senha √© imediatamente descartada ap√≥s deriva√ß√£o
     */
    async deriveKey(password, salt) {
        const enc = new TextEncoder();
        const passwordBuffer = enc.encode(password);
        
        // Importa senha como chave
        const baseKey = await crypto.subtle.importKey(
            'raw',
            passwordBuffer,
            'PBKDF2',
            false,
            ['deriveBits', 'deriveKey']
        );
        
        // Deriva chave AES
        const key = await crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: salt,
                iterations: this.PBKDF2_ITERATIONS,
                hash: 'SHA-256'
            },
            baseKey,
            { name: 'AES-GCM', length: 256 },
            false,  // N√£o export√°vel
            ['encrypt', 'decrypt']
        );
        
        // Limpa buffer da senha
        Security.zeroize(passwordBuffer);
        
        return key;
    },
    
    /**
     * Criptografa dados com AES-GCM
     * Usa IV √∫nico e AAD para integridade
     */
    async encrypt(data, key) {
        const enc = new TextEncoder();
        const plaintext = enc.encode(JSON.stringify(data));
        
        // IV aleat√≥rio √∫nico
        const iv = crypto.getRandomValues(new Uint8Array(this.IV_LENGTH));
        
        // Additional Authenticated Data - estrutura do vault
        const aad = enc.encode('VAULT_V1_' + Date.now());
        
        // Criptografa
        const ciphertext = await crypto.subtle.encrypt(
            {
                name: 'AES-GCM',
                iv: iv,
                additionalData: aad,
                tagLength: this.TAG_LENGTH
            },
            key,
            plaintext
        );
        
        // Retorna tudo necess√°rio para descriptografar
        return {
            iv: Array.from(iv),
            aad: Array.from(aad),
            data: Array.from(new Uint8Array(ciphertext))
        };
    },
    
    /**
     * Descriptografa dados com AES-GCM
     * Valida integridade via AAD
     */
    async decrypt(encryptedData, key) {
        if (!encryptedData || !encryptedData.iv || !encryptedData.data) {
            return null;
        }
        
        try {
            const iv = new Uint8Array(encryptedData.iv);
            const aad = new Uint8Array(encryptedData.aad || []);
            const ciphertext = new Uint8Array(encryptedData.data);
            
            const plaintext = await crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: iv,
                    additionalData: aad,
                    tagLength: this.TAG_LENGTH
                },
                key,
                ciphertext
            );
            
            const dec = new TextDecoder();
            return JSON.parse(dec.decode(plaintext));
        } catch (e) {
            // Falha na descriptografia ou valida√ß√£o
            return null;
        }
    }
};

// ===== STORAGE MODULE =====
class VaultStore {
    constructor() {
        this.currentKey = null;  // Chave tempor√°ria em mem√≥ria
        this.vault = null;       // Dados descriptografados tempor√°rios
        this.salt = null;
        this.authExpiry = 0;
        this.config = { emailSvc: 'tuamae' };
    }
    
    /**
     * Cria novo vault
     */
    async createVault(password) {
        // Gera salt aleat√≥rio
        this.salt = crypto.getRandomValues(new Uint8Array(Crypto.SALT_LENGTH));
        
        // Deriva chave (senha √© descartada)
        this.currentKey = await Crypto.deriveKey(password, this.salt);
        
        // Estrutura inicial
        this.vault = {
            version: 1,
            blks: [{ id: 'default', name: 'Geral' }],
            pwds: [],
            prs: [],
            notes: []
        };
        
        // Salva criptografado
        await this.saveVault();
        
        // Define expira√ß√£o da autentica√ß√£o
        this.authExpiry = Date.now() + 60000; // 1 minuto
        
        return true;
    }
    
    /**
     * Abre vault existente
     * Testa descriptografia para validar senha
     */
    async openVault(password) {
        const stored = localStorage.getItem('vault');
        if (!stored) return false;
        
        try {
            const vaultData = JSON.parse(stored);
            this.salt = new Uint8Array(vaultData.salt);
            
            // Deriva chave
            const testKey = await Crypto.deriveKey(password, this.salt);
            
            // Tenta descriptografar para validar senha
            const decrypted = await Crypto.decrypt(vaultData.data, testKey);
            
            if (!decrypted) {
                // Senha incorreta ou dados corrompidos
                return false;
            }
            
            // Sucesso - mant√©m chave e dados
            this.currentKey = testKey;
            this.vault = decrypted;
            this.authExpiry = Date.now() + 60000;
            
            // Carrega configura√ß√µes
            const cfg = localStorage.getItem('config');
            if (cfg) {
                try {
                    this.config = JSON.parse(cfg);
                } catch {}
            }
            
            return true;
        } catch {
            return false;
        }
    }
    
    /**
     * Re-autentica testando descriptografia
     * Nunca compara senhas diretamente
     */
    async reAuthenticate(password) {
        if (!this.salt) return false;
        
        try {
            // Deriva nova chave
            const testKey = await Crypto.deriveKey(password, this.salt);
            
            // Pega dados salvos
            const stored = localStorage.getItem('vault');
            if (!stored) return false;
            
            const vaultData = JSON.parse(stored);
            
            // Testa descriptografia
            const decrypted = await Crypto.decrypt(vaultData.data, testKey);
            
            if (!decrypted) {
                return false;
            }
            
            // Sucesso - atualiza chave e expiry
            this.currentKey = testKey;
            this.authExpiry = Date.now() + 60000;
            
            return true;
        } catch {
            return false;
        }
    }
    
    /**
     * Salva vault criptografado
     */
    async saveVault() {
        if (!this.currentKey || !this.vault) return false;
        
        try {
            const encrypted = await Crypto.encrypt(this.vault, this.currentKey);
            
            localStorage.setItem('vault', JSON.stringify({
                salt: Array.from(this.salt),
                data: encrypted,
                timestamp: Date.now()
            }));
            
            return true;
        } catch {
            return false;
        }
    }
    
    /**
     * Verifica se vault existe
     */
    exists() {
        return localStorage.getItem('vault') !== null;
    }
    
    /**
     * Verifica se autentica√ß√£o ainda √© v√°lida
     */
    isAuthenticated() {
        return this.currentKey !== null && Date.now() < this.authExpiry;
    }
    
    /**
     * Limpa dados sens√≠veis da mem√≥ria
     */
    lock() {
        this.currentKey = null;
        Security.zeroize(this.vault);
        this.vault = null;
        this.authExpiry = 0;
    }
    
    /**
     * Salva configura√ß√µes (n√£o criptografadas)
     */
    saveConfig() {
        localStorage.setItem('config', JSON.stringify(this.config));
    }
}

// ===== APPLICATION CONTROLLER =====
class App {
    constructor() {
        this.store = new VaultStore();
        this.currentBlock = 'default';
        this.pendingAction = null;
        
        this.init();
    }
    
    /**
     * Inicializa aplica√ß√£o
     */
    init() {
        this.attachEventListeners();
        
        if (this.store.exists()) {
            this.showLogin();
        } else {
            this.showRegister();
        }
    }
    
    /**
     * Anexa todos event listeners
     * Evita inline handlers para CSP
     */
    attachEventListeners() {
        // Auth form
        const authForm = document.getElementById('authForm');
        if (authForm) {
            authForm.addEventListener('submit', (e) => this.handleAuth(e));
        }
        
        // Re-auth form
        const reauthForm = document.getElementById('reauthForm');
        if (reauthForm) {
            reauthForm.addEventListener('submit', (e) => this.handleReAuth(e));
        }
        
        // Menu items
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => this.switchSection(e));
        });
        
        // Buttons
        this.attachButtonListener('logoutBtn', () => this.logout());
        this.attachButtonListener('configBtn', () => this.openModal('configModal'));
        this.attachButtonListener('addBlkBtn', () => this.openModal('blkModal'));
        this.attachButtonListener('addPwdBtn', () => this.checkAuthAndDo(() => this.openPasswordModal()));
        this.attachButtonListener('addNoteBtn', () => this.openNoteModal());
        this.attachButtonListener('genPwdBtn', () => this.generatePassword());
        this.attachButtonListener('copyGenBtn', () => this.copyGenerated());
        this.attachButtonListener('genQuickPwdBtn', () => this.generateQuickPassword());
        this.attachButtonListener('genPersonBtn', () => this.generatePerson());
        this.attachButtonListener('showSavedPersonsBtn', () => this.showSavedPersons());
        this.attachButtonListener('saveConfigBtn', () => this.saveConfig());
        
        // Modal close buttons
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.dataset.modal;
                if (modal) this.closeModal(modal);
            });
        });
        
        // Forms
        this.attachFormListener('blkForm', (e) => this.saveBlock(e));
        this.attachFormListener('pwdForm', (e) => this.savePassword(e));
        this.attachFormListener('noteForm', (e) => this.saveNote(e));
    }
    
    attachButtonListener(id, handler) {
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', handler);
    }
    
    attachFormListener(id, handler) {
        const form = document.getElementById(id);
        if (form) form.addEventListener('submit', handler);
    }
    
    /**
     * Mostra tela de login
     */
    showLogin() {
        const authMsg = document.getElementById('authMsg');
        const authBtnTxt = document.getElementById('authBtnTxt');
        const confirmGroup = document.getElementById('confirmGroup');
        
        if (authMsg) authMsg.textContent = 'Digite sua senha mestre para acessar';
        if (authBtnTxt) authBtnTxt.textContent = 'Entrar';
        if (confirmGroup) confirmGroup.style.display = 'none';
    }
    
    /**
     * Mostra tela de registro
     */
    showRegister() {
        const authMsg = document.getElementById('authMsg');
        const authBtnTxt = document.getElementById('authBtnTxt');
        const confirmGroup = document.getElementById('confirmGroup');
        
        if (authMsg) authMsg.textContent = 'Crie uma senha mestre para proteger seus dados';
        if (authBtnTxt) authBtnTxt.textContent = 'Criar Senha';
        if (confirmGroup) confirmGroup.style.display = 'block';
    }
    
    /**
     * Processa autentica√ß√£o
     */
    async handleAuth(e) {
        e.preventDefault();
        
        // Rate limiting
        if (!Security.checkRate('auth')) {
            this.showToast('Muitas tentativas. Aguarde 1 minuto.', 'error');
            return;
        }
        
        const passwordInput = document.getElementById('masterPwd');
        const confirmInput = document.getElementById('confirmPwd');
        const btn = document.getElementById('authBtn');
        
        const password = passwordInput.value;
        const confirm = confirmInput ? confirmInput.value : '';
        
        // Valida√ß√£o
        if (!Security.validate(password, 128)) {
            this.showToast('Senha cont√©m caracteres inv√°lidos', 'error');
            return;
        }
        
        // Desabilita bot√£o durante processamento
        btn.disabled = true;
        
        try {
            if (this.store.exists()) {
                // Login
                const success = await this.store.openVault(password);
                
                if (success) {
                    this.enterDashboard();
                } else {
                    this.showToast('Senha incorreta', 'error');
                }
            } else {
                // Registro
                if (password !== confirm) {
                    this.showToast('Senhas n√£o coincidem', 'error');
                    return;
                }
                
                await this.store.createVault(password);
                this.enterDashboard();
            }
        } finally {
            // Limpa campos e reabilita bot√£o
            passwordInput.value = '';
            if (confirmInput) confirmInput.value = '';
            btn.disabled = false;
        }
    }
    
    /**
     * Processa re-autentica√ß√£o
     */
    async handleReAuth(e) {
        e.preventDefault();
        
        if (!Security.checkRate('reauth')) {
            this.showToast('Muitas tentativas. Aguarde.', 'error');
            return;
        }
        
        const passwordInput = document.getElementById('authPwd');
        const password = passwordInput.value;
        
        if (!Security.validate(password, 128)) {
            this.showToast('Senha inv√°lida', 'error');
            return;
        }
        
        const success = await this.store.reAuthenticate(password);
        
        if (success) {
            this.closeModal('authModal');
            
            // Executa a√ß√£o pendente
            if (this.pendingAction) {
                this.pendingAction();
                this.pendingAction = null;
            }
            
            this.showToast('Autenticado', 'success');
        } else {
            this.showToast('Senha incorreta', 'error');
        }
        
        passwordInput.value = '';
    }
    
    /**
     * Entra no dashboard
     */
    enterDashboard() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        this.loadBlocks();
        this.loadPasswords();
        this.loadNotes();
        
        this.showToast('Bem-vindo!', 'success');
    }
    
    /**
     * Verifica autentica√ß√£o antes de a√ß√£o sens√≠vel
     */
    checkAuthAndDo(action) {
        if (this.store.isAuthenticated()) {
            action();
        } else {
            this.pendingAction = action;
            this.openModal('authModal');
        }
    }
    
    /**
     * Logout
     */
    logout() {
        if (confirm('Deseja sair?')) {
            this.store.lock();
            location.reload();
        }
    }
    
    /**
     * Troca se√ß√£o ativa
     */
    switchSection(e) {
        const section = e.currentTarget.dataset.section;
        if (!section) return;
        
        // Atualiza menu
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });
        e.currentTarget.classList.add('active');
        
        // Atualiza conte√∫do
        document.querySelectorAll('.section').forEach(sec => {
            sec.classList.remove('active');
        });
        
        const targetSection = document.getElementById(section);
        if (targetSection) {
            targetSection.classList.add('active');
        }
    }
    
    /**
     * Carrega lista de blocos
     */
    loadBlocks() {
        const container = document.getElementById('blkList');
        if (!container || !this.store.vault) return;
        
        // Limpa container
        container.innerHTML = '';
        
        this.store.vault.blks.forEach(block => {
            const div = document.createElement('div');
            div.className = `blk-item ${block.id === this.currentBlock ? 'active' : ''}`;
            
            const span = document.createElement('span');
            span.textContent = block.name; // textContent previne XSS
            span.style.cursor = 'pointer';
            span.addEventListener('click', () => this.selectBlock(block.id));
            
            div.appendChild(span);
            
            // Bot√£o deletar (exceto default)
            if (block.id !== 'default') {
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-icon';
                delBtn.style.padding = '4px';
                delBtn.textContent = '‚úï';
                delBtn.addEventListener('click', () => this.deleteBlock(block.id));
                div.appendChild(delBtn);
            }
            
            container.appendChild(div);
        });
    }
    
    /**
     * Seleciona bloco
     */
    selectBlock(id) {
        this.currentBlock = id;
        this.loadBlocks();
        this.loadPasswords();
        this.loadNotes();
    }
    
    /**
     * Salva novo bloco
     */
    async saveBlock(e) {
        e.preventDefault();
        
        const nameInput = document.getElementById('blkName');
        const name = nameInput.value;
        
        if (!Security.validate(name, 50)) {
            this.showToast('Nome inv√°lido', 'error');
            return;
        }
        
        const id = 'blk_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        this.store.vault.blks.push({ id, name });
        await this.store.saveVault();
        
        this.loadBlocks();
        this.closeModal('blkModal');
        this.showToast('Bloco criado');
        
        nameInput.value = '';
    }
    
    /**
     * Deleta bloco
     */
    async deleteBlock(id) {
        if (!confirm('Excluir bloco e todo conte√∫do?')) return;
        
        this.store.vault.blks = this.store.vault.blks.filter(b => b.id !== id);
        this.store.vault.pwds = this.store.vault.pwds.filter(p => p.blk !== id);
        this.store.vault.notes = this.store.vault.notes.filter(n => n.blk !== id);
        
        await this.store.saveVault();
        
        if (this.currentBlock === id) {
            this.currentBlock = 'default';
        }
        
        this.loadBlocks();
        this.loadPasswords();
        this.loadNotes();
        
        this.showToast('Bloco exclu√≠do');
    }
    
    /**
     * Carrega lista de senhas
     */
    loadPasswords() {
        const container = document.getElementById('pwdList');
        if (!container || !this.store.vault) return;
        
        const passwords = this.store.vault.pwds.filter(p => p.blk === this.currentBlock);
        
        if (passwords.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--txt-sec)">Nenhuma senha salva</p>';
            return;
        }
        
        container.innerHTML = '';
        
        passwords.forEach(pwd => {
            const card = document.createElement('div');
            card.className = 'pwd-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'pwd-header';
            
            const info = document.createElement('div');
            
            const site = document.createElement('div');
            site.className = 'pwd-site';
            site.textContent = pwd.site; // textContent previne XSS
            
            const user = document.createElement('div');
            user.className = 'pwd-user';
            user.textContent = pwd.usr;
            
            info.appendChild(site);
            info.appendChild(user);
            
            const expandBtn = document.createElement('button');
            expandBtn.className = 'btn btn-expand';
            expandBtn.textContent = 'Ver Mais';
            
            header.appendChild(info);
            header.appendChild(expandBtn);
            
            // Details
            const details = document.createElement('div');
            details.className = 'pwd-details';
            details.id = `pwd-${pwd.id}`;
            
            const field = document.createElement('div');
            field.className = 'pwd-field';
            
            const label = document.createElement('label');
            label.textContent = 'Senha';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'pwd-value-wrapper';
            
            const value = document.createElement('div');
            value.className = 'pwd-value';
            value.id = `pwdval-${pwd.id}`;
            value.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            
            const showBtn = document.createElement('button');
            showBtn.className = 'btn-icon';
            showBtn.textContent = 'üëÅ';
            showBtn.addEventListener('click', () => this.togglePasswordVisibility(pwd.id));
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn-icon';
            copyBtn.textContent = 'üìã';
            copyBtn.addEventListener('click', () => this.copyPassword(pwd.id));
            
            wrapper.appendChild(value);
            wrapper.appendChild(showBtn);
            wrapper.appendChild(copyBtn);
            
            field.appendChild(label);
            field.appendChild(wrapper);
            
            const actions = document.createElement('div');
            actions.style.marginTop = '16px';
            actions.style.display = 'flex';
            actions.style.gap = '8px';
            
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-danger';
            delBtn.textContent = 'Excluir';
            delBtn.addEventListener('click', () => this.deletePassword(pwd.id));
            
            actions.appendChild(delBtn);
            
            details.appendChild(field);
            details.appendChild(actions);
            
            // Toggle details
            header.addEventListener('click', () => {
                details.classList.toggle('show');
            });
            
            card.appendChild(header);
            card.appendChild(details);
            container.appendChild(card);
        });
    }
    
    /**
     * Abre modal de senha
     */
    openPasswordModal() {
        const select = document.getElementById('pwdBlk');
        if (!select) return;
        
        select.innerHTML = '';
        
        this.store.vault.blks.forEach(blk => {
            const option = document.createElement('option');
            option.value = blk.id;
            option.textContent = blk.name;
            if (blk.id === this.currentBlock) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        this.openModal('pwdModal');
    }
    
    /**
     * Salva senha
     */
    async savePassword(e) {
        e.preventDefault();
        
        const blk = document.getElementById('pwdBlk').value;
        const site = document.getElementById('pwdSite').value;
        const usr = document.getElementById('pwdUsr').value;
        const val = document.getElementById('pwdVal').value;
        
        // Valida√ß√£o
        if (!Security.validate(site, 100) || 
            !Security.validate(usr, 200) || 
            !Security.validate(val, 500)) {
            this.showToast('Dados inv√°lidos', 'error');
            return;
        }
        
        const pwd = {
            id: 'pwd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            blk,
            site,
            usr,
            val
        };
        
        this.store.vault.pwds.push(pwd);
        await this.store.saveVault();
        
        this.loadPasswords();
        this.closeModal('pwdModal');
        this.showToast('Senha salva');
        
        e.target.reset();
    }
    
    /**
     * Alterna visibilidade da senha
     */
    togglePasswordVisibility(id) {
        const element = document.getElementById(`pwdval-${id}`);
        if (!element) return;
        
        const pwd = this.store.vault.pwds.find(p => p.id === id);
        if (!pwd) return;
        
        if (element.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
            element.textContent = pwd.val;
        } else {
            element.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        }
    }
    
    /**
     * Copia senha
     */
    copyPassword(id) {
        const pwd = this.store.vault.pwds.find(p => p.id === id);
        if (!pwd) return;
        
        navigator.clipboard.writeText(pwd.val).then(() => {
            this.showToast('Senha copiada');
        }).catch(() => {
            this.showToast('Erro ao copiar', 'error');
        });
    }
    
    /**
     * Deleta senha
     */
    async deletePassword(id) {
        if (!confirm('Excluir senha?')) return;
        
        this.store.vault.pwds = this.store.vault.pwds.filter(p => p.id !== id);
        await this.store.saveVault();
        
        this.loadPasswords();
        this.showToast('Senha exclu√≠da');
    }
    
    /**
     * Gera senha forte
     */
    generatePassword() {
        const length = parseInt(document.getElementById('genLen').value) || 16;
        const useUpper = document.getElementById('genUpper').checked;
        const useLower = document.getElementById('genLower').checked;
        const useNumbers = document.getElementById('genNum').checked;
        const useSymbols = document.getElementById('genSym').checked;
        
        let charset = '';
        if (useUpper) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (useLower) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (useNumbers) charset += '0123456789';
        if (useSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
        
        if (!charset) {
            this.showToast('Selecione pelo menos uma op√ß√£o', 'error');
            return;
        }
        
        let password = '';
        const array = new Uint8Array(length);
        crypto.getRandomValues(array);
        
        for (let i = 0; i < length; i++) {
            password += charset[array[i] % charset.length];
        }
        
        const input = document.getElementById('genPwd');
        if (input) input.value = password;
    }
    
    /**
     * Copia senha gerada
     */
    copyGenerated() {
        const input = document.getElementById('genPwd');
        if (!input || !input.value) return;
        
        navigator.clipboard.writeText(input.value).then(() => {
            this.showToast('Copiado!');
        });
    }
    
    /**
     * Gera senha r√°pida
     */
    generateQuickPassword() {
        const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        const array = new Uint8Array(16);
        crypto.getRandomValues(array);
        
        for (let i = 0; i < 16; i++) {
            password += charset[array[i] % charset.length];
        }
        
        const input = document.getElementById('pwdVal');
        if (input) input.value = password;
    }
    
    /**
     * Gera pessoa fict√≠cia
     */
    generatePerson() {
        const names = ['Jo√£o', 'Maria', 'Pedro', 'Ana', 'Carlos', 'Julia', 'Lucas', 'Mariana'];
        const surnames = ['Silva', 'Santos', 'Oliveira', 'Souza', 'Lima', 'Costa', 'Ferreira'];
        
        const name = names[Math.floor(Math.random() * names.length)] + ' ' + 
                    surnames[Math.floor(Math.random() * surnames.length)];
        
        const cpf = this.generateCPF();
        
        const year = 1950 + Math.floor(Math.random() * 50);
        const month = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
        const day = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
        const birthdate = `${day}/${month}/${year}`;
        
        const emailUser = name.toLowerCase().replace(' ', '.') + Math.floor(Math.random() * 999);
        const service = this.store.config.emailSvc || 'tuamae';
        
        let email, link;
        if (service === 'tuamae') {
            email = emailUser + '@tuamaeaquelaursa.com';
            link = `https://tuamaeaquelaursa.com/${emailUser}`;
        } else {
            email = emailUser + '@firemail.com.br';
            link = `https://firemail.com.br/${emailUser}`;
        }
        
        const streets = ['Rua das Flores', 'Av. Brasil', 'Rua Principal'];
        const address = streets[Math.floor(Math.random() * streets.length)] + ', ' + 
                       Math.floor(Math.random() * 999);
        
        const person = { name, cpf, birthdate, email, link, address };
        
        this.displayPerson(person);
    }
    
    /**
     * Gera CPF v√°lido
     */
    generateCPF() {
        const nums = Array.from({length: 9}, () => Math.floor(Math.random() * 10));
        
        // Primeiro d√≠gito
        let sum = 0;
        for (let i = 0; i < 9; i++) {
            sum += nums[i] * (10 - i);
        }
        let d1 = 11 - (sum % 11);
        if (d1 >= 10) d1 = 0;
        nums.push(d1);
        
        // Segundo d√≠gito
        sum = 0;
        for (let i = 0; i < 10; i++) {
            sum += nums[i] * (11 - i);
        }
        let d2 = 11 - (sum % 11);
        if (d2 >= 10) d2 = 0;
        nums.push(d2);
        
        return nums.slice(0,3).join('') + '.' + 
               nums.slice(3,6).join('') + '.' + 
               nums.slice(6,9).join('') + '-' + 
               nums.slice(9,11).join('');
    }
    
    /**
     * Exibe pessoa gerada
     */
    displayPerson(person) {
        const container = document.getElementById('personContent');
        if (!container) return;
        
        container.innerHTML = '';
        
        const card = document.createElement('div');
        card.className = 'person-card';
        
        // Campos
        const fields = [
            { label: 'Nome', value: person.name },
            { label: 'CPF', value: person.cpf },
            { label: 'Nascimento', value: person.birthdate },
            { label: 'Email', value: person.email, hasActions: true, link: person.link },
            { label: 'Endere√ßo', value: person.address }
        ];
        
        fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'person-field';
            
            const label = document.createElement('span');
            label.className = 'field-label';
            label.textContent = field.label + ':';
            
            const valueDiv = document.createElement('span');
            valueDiv.className = 'field-value';
            
            if (field.hasActions) {
                const emailSpan = document.createElement('span');
                emailSpan.id = 'personEmail';
                emailSpan.textContent = field.value;
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-icon';
                editBtn.textContent = '‚úè';
                editBtn.addEventListener('click', () => this.changeEmailDomain());
                
                const linkBtn = document.createElement('button');
                linkBtn.className = 'btn-icon';
                linkBtn.textContent = '‚Üó';
                linkBtn.addEventListener('click', () => window.open(field.link, '_blank'));
                
                valueDiv.appendChild(emailSpan);
                valueDiv.appendChild(editBtn);
                valueDiv.appendChild(linkBtn);
            } else {
                valueDiv.textContent = field.value;
            }
            
            div.appendChild(label);
            div.appendChild(valueDiv);
            card.appendChild(div);
        });
        
        container.appendChild(card);
        
        // Bot√µes
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '12px';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-primary';
        saveBtn.textContent = 'Salvar Preset';
        saveBtn.addEventListener('click', () => this.savePerson(person));
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-secondary';
        copyBtn.textContent = 'Copiar Dados';
        copyBtn.addEventListener('click', () => this.copyPerson(person));
        
        actions.appendChild(saveBtn);
        actions.appendChild(copyBtn);
        container.appendChild(actions);
    }
    
    /**
     * Altera dom√≠nio do email
     */
    changeEmailDomain() {
        const emailEl = document.getElementById('personEmail');
        if (!emailEl) return;
        
        const current = emailEl.textContent;
        const user = current.split('@')[0];
        
        if (current.includes('@tuamaeaquelaursa')) {
            emailEl.textContent = user + '@firemail.com.br';
        } else if (current.includes('@firemail')) {
            emailEl.textContent = user + '@email.com';
        } else {
            emailEl.textContent = user + '@tuamaeaquelaursa.com';
        }
    }
    
    /**
     * Salva pessoa
     */
    async savePerson(person) {
        person.id = 'prs_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        if (!this.store.vault.prs) {
            this.store.vault.prs = [];
        }
        
        this.store.vault.prs.push(person);
        await this.store.saveVault();
        
        this.showToast('Pessoa salva');
    }
    
    /**
     * Copia dados da pessoa
     */
    copyPerson(person) {
        const text = `Nome: ${person.name}\nCPF: ${person.cpf}\nNascimento: ${person.birthdate}\nEmail: ${person.email}\nEndere√ßo: ${person.address}`;
        
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Dados copiados');
        });
    }
    
    /**
     * Mostra pessoas salvas
     */
    showSavedPersons() {
        const container = document.getElementById('personContent');
        if (!container) return;
        
        if (!this.store.vault.prs || this.store.vault.prs.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--txt-sec)">Nenhuma pessoa salva</p>';
            return;
        }
        
        container.innerHTML = '';
        
        this.store.vault.prs.forEach(person => {
            const card = document.createElement('div');
            card.className = 'person-card';
            
            // Campos b√°sicos
            const fields = [
                { label: 'Nome', value: person.name },
                { label: 'CPF', value: person.cpf },
                { label: 'Nascimento', value: person.birthdate },
                { label: 'Email', value: person.email }
            ];
            
            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'person-field';
                
                const label = document.createElement('span');
                label.className = 'field-label';
                label.textContent = field.label + ':';
                
                const value = document.createElement('span');
                value.className = 'field-value';
                value.textContent = field.value;
                
                div.appendChild(label);
                div.appendChild(value);
                card.appendChild(div);
            });
            
            // A√ß√µes
            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '12px';
            actions.style.marginTop = '16px';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn-icon';
            copyBtn.textContent = 'üìã';
            copyBtn.addEventListener('click', () => this.copyPerson(person));
            
            const delBtn = document.createElement('button');
            delBtn.className = 'btn-icon';
            delBtn.textContent = 'üóë';
            delBtn.addEventListener('click', () => this.deletePerson(person.id));
            
            actions.appendChild(copyBtn);
            actions.appendChild(delBtn);
            card.appendChild(actions);
            
            container.appendChild(card);
        });
    }
    
    /**
     * Deleta pessoa
     */
    async deletePerson(id) {
        if (!confirm('Excluir pessoa?')) return;
        
        this.store.vault.prs = this.store.vault.prs.filter(p => p.id !== id);
        await this.store.saveVault();
        
        this.showSavedPersons();
        this.showToast('Pessoa exclu√≠da');
    }
    
    /**
     * Carrega notas
     */
    loadNotes() {
        const container = document.getElementById('notesList');
        if (!container || !this.store.vault) return;
        
        const notes = this.store.vault.notes ? 
            this.store.vault.notes.filter(n => n.blk === this.currentBlock) : [];
        
        if (notes.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--txt-sec)">Nenhuma anota√ß√£o salva</p>';
            return;
        }
        
        container.innerHTML = '';
        
        notes.forEach(note => {
            const card = document.createElement('div');
            card.className = 'note-card';
            card.addEventListener('click', () => this.showNoteDetail(note));
            
            const title = document.createElement('div');
            title.className = 'note-title';
            title.textContent = note.title;
            
            const preview = document.createElement('div');
            preview.className = 'note-preview';
            preview.textContent = note.content.substring(0, 100) + '...';
            
            card.appendChild(title);
            card.appendChild(preview);
            container.appendChild(card);
        });
    }
    
    /**
     * Abre modal de nota
     */
    openNoteModal() {
        const select = document.getElementById('noteBlk');
        if (!select) return;
        
        select.innerHTML = '';
        
        this.store.vault.blks.forEach(blk => {
            const option = document.createElement('option');
            option.value = blk.id;
            option.textContent = blk.name;
            if (blk.id === this.currentBlock) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        this.openModal('noteModal');
    }
    
    /**
     * Salva nota
     */
    async saveNote(e) {
        e.preventDefault();
        
        const blk = document.getElementById('noteBlk').value;
        const title = document.getElementById('noteTitle').value;
        const content = document.getElementById('noteContent').value;
        
        if (!Security.validate(title, 100) || !Security.validate(content, 5000)) {
            this.showToast('Dados inv√°lidos', 'error');
            return;
        }
        
        const note = {
            id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            blk,
            title,
            content
        };
        
        if (!this.store.vault.notes) {
            this.store.vault.notes = [];
        }
        
        this.store.vault.notes.push(note);
        await this.store.saveVault();
        
        this.loadNotes();
        this.closeModal('noteModal');
        this.showToast('Anota√ß√£o salva');
        
        e.target.reset();
    }
    
    /**
     * Mostra detalhes da nota
     */
    showNoteDetail(note) {
        alert(`${note.title}\n\n${note.content}`);
    }
    
    /**
     * Salva configura√ß√µes
     */
    saveConfig() {
        const service = document.querySelector('input[name="emailSvc"]:checked');
        if (!service) return;
        
        this.store.config.emailSvc = service.value;
        this.store.saveConfig();
        
        this.closeModal('configModal');
        this.showToast('Configura√ß√µes salvas');
    }
    
    /**
     * Abre modal
     */
    openModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.classList.add('active');
    }
    
    /**
     * Fecha modal
     */
    closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('active');
    }
    
    /**
     * Mostra toast
     */
    showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const msg = document.getElementById('toastMsg');
        
        if (!toast || !msg) return;
        
        msg.textContent = message;
        toast.className = `toast show ${type}`;
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
}


const app = new App();


window.addEventListener('load', () => {
    setTimeout(() => {
        const genBtn = document.getElementById('genPwdBtn');
        if (genBtn) genBtn.click();
    }, 100);
});
</script>

</body>
</html>
